<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LUNEVIRA â€” Ù…ØªØ¬Ø± Ù…ØªÙƒØ§Ù…Ù„</title>
<style>
  :root{
    --bg:#0b0f1a; --card:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
    --text:#f5f7ff; --muted:rgba(245,247,255,.72);
    --gold:#d4af37; --gold2:#f1d37a; --ok:#22c55e; --bad:#ef4444;
    --r:18px; --shadow:0 18px 60px rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
    background:
      radial-gradient(900px 600px at 80% -10%, rgba(212,175,55,.22), transparent 55%),
      radial-gradient(700px 500px at 10% 10%, rgba(124,58,237,.18), transparent 60%),
      linear-gradient(180deg,#070a12,var(--bg));
    min-height:100vh;
  }
  .wrap{width:min(1100px,100%);margin:0 auto;padding:16px}
  .top{position:sticky;top:0;z-index:10;background:rgba(7,10,18,.76);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
  .nav{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:42px;height:42px;border-radius:14px;border:1px solid var(--line);
    background:linear-gradient(135deg,rgba(212,175,55,.22),rgba(255,255,255,.06));
    display:grid;place-items:center;box-shadow:0 10px 30px rgba(0,0,0,.35)
  }
  .brand h1{margin:0;font-size:16px;letter-spacing:1px}
  .brand p{margin:0;font-size:12px;color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;border:1px solid var(--line);
    background:rgba(255,255,255,.06);cursor:pointer;font-size:12px;user-select:none}
  .pill:active{transform:translateY(1px)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{border:1px solid var(--line);background:rgba(255,255,255,.05);border-radius:var(--r);box-shadow:var(--shadow)}
  .panel{padding:14px}
  .h{margin:0 0 8px;font-size:16px}
  .muted{color:var(--muted);font-size:13px;line-height:1.7}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:900px){.row{grid-template-columns:1fr}}
  input,select,textarea{width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);
    background:rgba(255,255,255,.06);color:var(--text);outline:none}
  textarea{min-height:90px;resize:vertical}
  .btn{border:0;border-radius:14px;padding:12px 14px;cursor:pointer;font-weight:900}
  .btn.gold{background:linear-gradient(135deg,var(--gold2),var(--gold));color:#071018}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
  .btn.ok{background:linear-gradient(135deg,#34d399,var(--ok));color:#06130b}
  .btn.bad{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.35);color:#ffd7d7}
  .sep{height:1px;background:var(--line);margin:12px 0}
  .items{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .item{grid-column:span 4;border:1px solid var(--line);background:rgba(255,255,255,.05);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
  @media(max-width:980px){.item{grid-column:span 6}}
  @media(max-width:560px){.item{grid-column:span 12}}
  .thumb{height:150px;background:linear-gradient(135deg,rgba(255,255,255,.05),rgba(255,255,255,.02));position:relative;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .tag{position:absolute;top:10px;right:10px;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
    background:rgba(0,0,0,.28);backdrop-filter:blur(8px)}
  .body{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
  .title{margin:0;font-size:14px}
  .desc{margin:0;color:var(--muted);font-size:12px;line-height:1.7}
  .meta{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:auto}
  .price{font-weight:900;color:var(--gold2)}
  .mini{font-size:12px;color:var(--muted)}
  .toast{position:fixed;left:16px;right:16px;bottom:16px;max-width:1100px;margin:0 auto;
    background:rgba(0,0,0,.78);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:12px 14px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;opacity:0;transform:translateY(14px);
    pointer-events:none;transition:.22s ease;z-index:50}
  .toast.show{opacity:1;transform:translateY(0);pointer-events:auto}
</style>
</head>
<body>

<div class="top">
  <div class="nav wrap">
    <div class="brand">
      <div class="logo">âœ¨</div>
      <div>
        <h1>LUNEVIRA</h1>
        <p>ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ â€¢ Ù…ØªØ¬Ø± â€¢ Ø¥Ø¹Ø§Ø¯Ø© Ø¨ÙŠØ¹ â€¢ Ø·Ù„Ø¨Ø§Øª</p>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <div class="pill" id="who">ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„</div>
      <div class="pill" id="btnCart">ğŸ›’ Ø§Ù„Ø³Ù„Ø© (<span id="cartCount">0</span>)</div>
      <div class="pill" id="btnLogout" style="display:none">ğŸšª Ø®Ø±ÙˆØ¬</div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="grid" style="gap:12px">
    <!-- Auth -->
    <section class="card" style="grid-column:span 5">
      <div class="panel">
        <h2 class="h">Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
        <p class="muted">Ø³Ø¬Ù‘Ù„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (ØªØ³Ø¬ÙŠÙ„/Ø¯Ø®ÙˆÙ„). Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ‚Ø¯Ø± ØªØ¹Ù…Ù„ Ø·Ù„Ø¨Ø§Øª ÙˆØªØ¶ÙŠÙ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ¹.</p>
        <div class="sep"></div>

        <div id="authBox">
          <div class="row">
            <div>
              <div class="mini">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</div>
              <input id="email" type="email" placeholder="name@example.com">
            </div>
            <div>
              <div class="mini">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
              <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
          </div>
          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <button class="btn gold" id="btnSignUp">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn ghost" id="btnSignIn">Ø¯Ø®ÙˆÙ„</button>
          </div>
          <p class="mini" style="margin-top:10px">
            Ø¥Ø°Ø§ Supabase Ù…ÙØ¹Ù‘Ù„ â€œEmail confirmationâ€ Ù…Ù…ÙƒÙ† ÙŠØ·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯.
          </p>
        </div>

        <div id="userBox" style="display:none">
          <p class="muted">âœ… Ø£Ù†Øª Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„.</p>
          <div class="sep"></div>

          <h3 class="h">Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨</h3>
          <div class="row">
            <input id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input id="phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
          </div>
          <textarea id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„"></textarea>
          <button class="btn ok" id="btnCheckout" style="margin-top:10px">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ (ÙŠØ³Ø¬Ù‘Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</button>
          <p class="mini">âš ï¸ Ù‡Ø°Ø§ Ù„ÙŠØ³ Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ù„ÙƒÙ†Ù‡ ÙŠØ³Ø¬Ù‘Ù„ â€œØ§Ù„Ø·Ù„Ø¨â€ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØªØ§Ø¨Ø¹Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
        </div>
      </div>
    </section>

    <!-- Store -->
    <section class="card" style="grid-column:span 7">
      <div class="panel">
        <h2 class="h">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
        <div class="row">
          <input id="search" placeholder="Ø¨Ø­Ø«... (Ø¹Ø·Ø± / Ù†Ø¸Ø§Ø±Ø§Øª)">
          <select id="filterCat">
            <option value="all">Ø§Ù„ÙƒÙ„</option>
            <option value="perfume">Ø¹Ø·ÙˆØ±</option>
            <option value="glasses">Ù†Ø¸Ø§Ø±Ø§Øª</option>
            <option value="resale">Ø¥Ø¹Ø§Ø¯Ø© Ø¨ÙŠØ¹</option>
          </select>
        </div>
        <div class="sep"></div>
        <div id="list" class="items"></div>
      </div>
    </section>

    <!-- Seller / Resale -->
    <section class="card" style="grid-column:span 12">
      <div class="panel">
        <h2 class="h">Ø¥Ø¹Ø§Ø¯Ø© Ø¨ÙŠØ¹ (Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹)</h2>
        <p class="muted">Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ùƒ Ù„ÙŠØ¸Ù‡Ø± Ø¶Ù…Ù† â€œØ¥Ø¹Ø§Ø¯Ø© Ø¨ÙŠØ¹â€.</p>
        <div class="sep"></div>

        <div id="sellerBox" style="display:none">
          <div class="row">
            <input id="sTitle" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input id="sPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„ 120)">
          </div>
          <div class="row">
            <select id="sCat">
              <option value="perfume">Ø¹Ø·ÙˆØ±</option>
              <option value="glasses">Ù†Ø¸Ø§Ø±Ø§Øª</option>
            </select>
            <input id="sImg" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          </div>
          <textarea id="sDesc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬"></textarea>
          <button class="btn gold" id="btnAddListing">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ¹</button>
          <div class="sep"></div>
          <h3 class="h">Ù…Ù†ØªØ¬Ø§ØªÙŠ</h3>
          <div id="myListings" class="items"></div>
        </div>

        <div id="sellerLock" class="muted">ğŸ”’ Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ³ØªØ¹Ù…Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹.</div>
      </div>
    </section>
  </div>
</div>

<div class="toast" id="toast">
  <div id="toastMsg">â€”</div>
  <button class="btn ghost" id="toastOk">Ø­Ø³Ù†Ù‹Ø§</button>
</div>

<!-- Supabase JS (CDN) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* ====== Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ (Ù…Ù† Supabase > Settings > API) ====== */
const SUPABASE_URL = "https://muowobprjsaiqxlcrtav.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11b3dvYnByanNhaXF4bGNydGF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2Mjc4MDEsImV4cCI6MjA4NjIwMzgwMX0.KTK4yPFO-GZHSDG41JBq1H4kHO17iR7pr9lRU4crbfE";
/* =============================================================== */

const $ = (id) => document.getElementById(id);

function toast(msg){
  $("toastMsg").textContent = msg;
  $("toast").classList.add("show");
  clearTimeout(window.__t);
  window.__t = setTimeout(()=> $("toast").classList.remove("show"), 3200);
}
$("toastOk").onclick = ()=> $("toast").classList.remove("show");

if(!SUPABASE_URL.startsWith("http") || SUPABASE_ANON_KEY.includes("PASTE_")){
  toast("âš ï¸ Ù„Ø§Ø²Ù… ØªÙ„ØµÙ‚ SUPABASE_URL Ùˆ SUPABASE_ANON_KEY Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯.");
}

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let sessionUser = null;
let cart = []; // {type:'product'|'listing', id, title, unit_price, qty}

function cartCount(){
  let c=0; cart.forEach(i=>c+=i.qty);
  $("cartCount").textContent = c;
  return c;
}

function addToCart(item){
  const key = item.type + ":" + item.id;
  const idx = cart.findIndex(x => (x.type+":"+x.id) === key);
  if(idx>=0) cart[idx].qty += 1;
  else cart.push({...item, qty:1});
  cartCount();
  toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© âœ…");
}

function renderCartAlert(){
  if(cart.length===0){ alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©"); return; }
  let lines = cart.map(i=>`- ${i.title} Ã— ${i.qty} = ${Number(i.unit_price)*i.qty}`);
  let total = cart.reduce((s,i)=> s + Number(i.unit_price)*i.qty, 0);
  alert("Ø§Ù„Ø³Ù„Ø©:\n"+lines.join("\n")+"\n\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: "+total);
}

$("btnCart").onclick = renderCartAlert;

function imgOrFallback(url){
  if(url && url.trim()) return url.trim();
  // fallback internal svg
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='900' height='600'>
    <defs>
      <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
        <stop offset='0' stop-color='#0b0f1a'/><stop offset='1' stop-color='#20162f'/>
      </linearGradient>
    </defs>
    <rect width='900' height='600' fill='url(#g)'/>
    <circle cx='220' cy='220' r='140' fill='rgba(212,175,55,.22)'/>
    <circle cx='680' cy='380' r='170' fill='rgba(124,58,237,.18)'/>
    <text x='60' y='520' fill='rgba(255,255,255,.75)' font-family='Arial' font-size='44'>LUNEVIRA</text>
  </svg>`;
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
}

function cardHTML(p){
  const tag = p.type === "listing" ? "Ø¥Ø¹Ø§Ø¯Ø© Ø¨ÙŠØ¹" : (p.category==="glasses" ? "Ù†Ø¸Ø§Ø±Ø§Øª" : "Ø¹Ø·Ø±");
  return `
    <div class="item">
      <div class="thumb">
        <span class="tag">${tag}</span>
        <img alt="" src="${imgOrFallback(p.image_url)}">
      </div>
      <div class="body">
        <h3 class="title">${p.title}</h3>
        <p class="desc">${p.description || "â€”"}</p>
        <div class="meta">
          <div class="price">${Number(p.price).toFixed(0)} Ø¯ÙŠÙ†Ø§Ø±</div>
          <div style="display:flex;gap:8px">
            <button class="btn ghost" onclick="viewItem('${p.type}','${p.id}')">ØªÙØ§ØµÙŠÙ„</button>
            <button class="btn gold" onclick="addItem('${p.type}','${p.id}','${escapeHtml(p.title)}','${p.price}')">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

window.viewItem = (type,id)=> toast(`Ø§Ù„Ù…Ù†ØªØ¬: ${type} / ${id}`);
window.addItem = (type,id,title,price)=> addToCart({type, id, title, unit_price:Number(price)});

async function loadStore(){
  const q = ($("search").value||"").trim().toLowerCase();
  const f = $("filterCat").value;

  // 1) products
  let prods = [];
  if(f !== "resale"){
    const {data, error} = await supabase.from("products").select("*").order("created_at",{ascending:false});
    if(error) { toast("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ products: "+error.message); }
    else prods = (data||[]).map(x=>({...x, type:"product"}));
  }

  // 2) listings (resale)
  let lists = [];
  if(f !== "all" ? (f==="resale") : true){
    const {data, error} = await supabase.from("listings").select("*").order("created_at",{ascending:false});
    if(error) { toast("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ listings: "+error.message); }
    else lists = (data||[]).map(x=>({...x, type:"listing"}));
  }

  let all = [...prods, ...lists];

  if(f==="perfume") all = all.filter(x=>x.type==="product" ? x.category==="perfume" : x.category==="perfume");
  if(f==="glasses") all = all.filter(x=>x.type==="product" ? x.category==="glasses" : x.category==="glasses");
  if(f==="resale") all = all.filter(x=>x.type==="listing");

  if(q) all = all.filter(x => (x.title||"").toLowerCase().includes(q) || (x.description||"").toLowerCase().includes(q));

  $("list").innerHTML = all.length ? all.map(cardHTML).join("") : `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>`;
}

$("search").addEventListener("input", ()=>{ clearTimeout(window.__s); window.__s=setTimeout(loadStore,200); });
$("filterCat").addEventListener("change", loadStore);

async function refreshSession(){
  const {data} = await supabase.auth.getSession();
  sessionUser = data.session?.user || null;

  if(sessionUser){
    $("who").textContent = sessionUser.email;
    $("btnLogout").style.display = "";
    $("authBox").style.display = "none";
    $("userBox").style.display = "";
    $("sellerBox").style.display = "";
    $("sellerLock").style.display = "none";
    await loadMyListings();
  }else{
    $("who").textContent = "ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„";
    $("btnLogout").style.display = "none";
    $("authBox").style.display = "";
    $("userBox").style.display = "none";
    $("sellerBox").style.display = "none";
    $("sellerLock").style.display = "";
  }
}

$("btnLogout").onclick = async ()=>{
  await supabase.auth.signOut();
  cart = []; cartCount();
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
  refreshSession();
};

$("btnSignUp").onclick = async ()=>{
  const email = $("email").value.trim();
  const password = $("password").value;
  if(!email || !password){ toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); return; }
  const {error} = await supabase.auth.signUp({ email, password });
  if(error) toast(error.message);
  else toast("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø­Ø³Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase.");
  refreshSession();
};

$("btnSignIn").onclick = async ()=>{
  const email = $("email").value.trim();
  const password = $("password").value;
  if(!email || !password){ toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); return; }
  const {error} = await supabase.auth.signInWithPassword({ email, password });
  if(error) toast(error.message);
  else toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…");
  refreshSession();
};

$("btnCheckout").onclick = async ()=>{
  if(!sessionUser){ toast("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„"); return; }
  if(cart.length===0){ toast("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©"); return; }

  const full_name = $("fullName").value.trim();
  const phone = $("phone").value.trim();
  const address = $("address").value.trim();
  if(!full_name || !phone || !address){ toast("Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†"); return; }

  const total = cart.reduce((s,i)=> s + Number(i.unit_price)*i.qty, 0);

  const {data:order, error:err1} = await supabase
    .from("orders")
    .insert([{ user_id: sessionUser.id, full_name, phone, address, total }])
    .select()
    .single();

  if(err1){ toast("Ø®Ø·Ø£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨: "+err1.message); return; }

  const items = cart.map(i=>({
    order_id: order.id,
    item_type: i.type,
    item_id: i.id,
    title: i.title,
    unit_price: Number(i.unit_price),
    qty: i.qty
  }));

  const {error:err2} = await supabase.from("order_items").insert(items);
  if(err2){ toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù„ÙƒÙ† Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±: "+err2.message); return; }

  cart = []; cartCount();
  toast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
};

$("btnAddListing").onclick = async ()=>{
  if(!sessionUser){ toast("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„"); return; }

  const title = $("sTitle").value.trim();
  const price = Number($("sPrice").value);
  const category = $("sCat").value;
  const image_url = $("sImg").value.trim();
  const description = $("sDesc").value.trim();

  if(!title || !Number.isFinite(price) || price<=0){ toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆØ³Ø¹Ø± ØµØ­ÙŠØ­"); return; }

  const {error} = await supabase.from("listings").insert([{
    seller_id: sessionUser.id, title, price, category, image_url, description, status:"active"
  }]);

  if(error) toast("Ø®Ø·Ø£ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬: "+error.message);
  else {
    toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ùƒ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ¹ âœ…");
    $("sTitle").value=""; $("sPrice").value=""; $("sImg").value=""; $("sDesc").value="";
    await loadMyListings();
    await loadStore();
  }
};

async function loadMyListings(){
  if(!sessionUser) return;
  const {data, error} = await supabase
    .from("listings")
    .select("*")
    .eq("seller_id", sessionUser.id)
    .order("created_at",{ascending:false});

  if(error){ toast("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§ØªÙŠ: "+error.message); return; }

  const mine = (data||[]).map(x=>({...x, type:"listing"}));
  $("myListings").innerHTML = mine.length ? mine.map(p=>`
    <div class="item">
      <div class="thumb">
        <span class="tag">Ù…Ù†ØªØ¬ÙŠ</span>
        <img alt="" src="${imgOrFallback(p.image_url)}">
      </div>
      <div class="body">
        <h3 class="title">${p.title}</h3>
        <p class="desc">${p.description || "â€”"}</p>
        <div class="meta">
          <div class="price">${Number(p.price).toFixed(0)} Ø¯ÙŠÙ†Ø§Ø±</div>
          <button class="btn bad" onclick="delListing('${p.id}')">Ø­Ø°Ù</button>
        </div>
      </div>
    </div>
  `).join("") : `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.</div>`;
}

window.delListing = async (id)=>{
  if(!sessionUser) return;
  const ok = confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ");
  if(!ok) return;
  const {error} = await supabase.from("listings").delete().eq("id", id);
  if(error) toast("Ø®Ø·Ø£ Ø§Ù„Ø­Ø°Ù: "+error.message);
  else { toast("ØªÙ… Ø§Ù„Ø­Ø°Ù"); loadMyListings(); loadStore(); }
};

supabase.auth.onAuthStateChange(()=> refreshSession());

// First load
refreshSession();
loadStore();
cartCount();
</script>
</body>
</html>
