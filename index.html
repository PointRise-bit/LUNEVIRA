<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LUNEVIRA Marketplace</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body{margin:0;font-family:Arial;background:#0b0f1a;color:#fff;padding:15px}
.card{border:1px solid rgba(255,255,255,.15);padding:15px;border-radius:15px;margin-top:15px;background:rgba(255,255,255,.05)}
input,select{width:100%;padding:10px;margin-top:8px;border-radius:10px;border:1px solid #444;background:#111;color:#fff}
button{padding:10px 15px;border-radius:10px;border:none;font-weight:bold;margin-top:10px;cursor:pointer}
.gold{background:gold;color:#000}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px}
.small{font-size:12px;opacity:.8}
</style>
</head>
<body>

<h2>LUNEVIRA Marketplace</h2>

<div class="card">
<h3>تسجيل / دخول</h3>
<input id="email" placeholder="email">
<input id="pass" type="password" placeholder="password">
<button class="gold" onclick="signup()">تسجيل</button>
<button onclick="login()">دخول</button>
<button onclick="logout()">خروج</button>
<div id="userBox"></div>
</div>

<div class="card">
<h3>إضافة منتج</h3>
<input id="pname" placeholder="اسم المنتج">
<input id="pprice" type="number" placeholder="السعر">
<input id="pimage" placeholder="رابط صورة">
<button class="gold" onclick="addProduct()">إضافة</button>
</div>

<div class="card">
<h3>المنتجات</h3>
<div id="products" class="grid"></div>
</div>

<script>

const TRC20 = "TUG7EVJBsZZ61K3X7hAik8438eLqXyVAQm";
const BEP20 = "0xec92a420efe51e1482bff48b604827734d313fab";
const COMMISSION = 0.08;

const supabase = supabase.createClient(
"https://muowobprjsaiqxlcrtav.supabase.co",
"YOUR_ANON_KEY_HERE"
);

async function signup(){
const email=document.getElementById("email").value;
const pass=document.getElementById("pass").value;
await supabase.auth.signUp({email,password:pass});
alert("تم التسجيل");
}

async function login(){
const email=document.getElementById("email").value;
const pass=document.getElementById("pass").value;
await supabase.auth.signInWithPassword({email,password:pass});
checkUser();
}

async function logout(){
await supabase.auth.signOut();
checkUser();
}

async function checkUser(){
const {data}=await supabase.auth.getSession();
const user=data.session?.user;
document.getElementById("userBox").innerHTML=user?`أنت داخل: ${user.email}`:"غير مسجل";
}
checkUser();

async function addProduct(){
const {data}=await supabase.auth.getSession();
const user=data.session?.user;
if(!user)return alert("سجل دخول");

await supabase.from("products").insert([{
name:document.getElementById("pname").value,
price:document.getElementById("pprice").value,
image:document.getElementById("pimage").value,
seller_id:user.id
}]);

loadProducts();
}

async function loadProducts(){
const {data}=await supabase.from("products").select("*");
let html="";
data.forEach(p=>{
html+=`
<div class="card">
<img src="${p.image}" width="100%">
<h4>${p.name}</h4>
<p>${p.price} USDT</p>
<button onclick="buy('${p.id}',${p.price})" class="gold">شراء</button>
</div>
`;
});
document.getElementById("products").innerHTML=html;
}
loadProducts();

async function buy(id,price){
const network=prompt("اكتب الشبكة: TRC20 أو BEP20");
const tx=prompt("اكتب Tx Hash");
if(!network||!tx)return;

const {data}=await supabase.auth.getSession();
const user=data.session?.user;
if(!user)return alert("سجل دخول");

const fee=price*COMMISSION;
const seller=price-fee;

await supabase.from("orders").insert([{
user_id:user.id,
product_id:id,
amount:price,
network:network,
tx_hash:tx,
platform_fee:fee,
seller_amount:seller,
status:"pending"
}]);

alert("أرسل المبلغ إلى:\n"+(network=="TRC20"?TRC20:BEP20));
}

</script>

</body>
</html>
