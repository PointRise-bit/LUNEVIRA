<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LUNEVIERA Marketplace</title>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#121826;
      --muted:#9aa4b2;
      --text:#e6edf6;
      --accent:#f5c542;
      --good:#22c55e;
      --bad:#ef4444;
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Tahoma, Arial;
      background: radial-gradient(1200px 700px at 80% -10%, rgba(245,197,66,.20), transparent 60%),
                  radial-gradient(900px 600px at 10% 0%, rgba(99,102,241,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background:rgba(18,24,38,.75);backdrop-filter: blur(10px); box-shadow: var(--shadow);
      position:sticky;top:10px;z-index:10;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:42px;height:42px;border-radius:12px;
      background: linear-gradient(135deg, rgba(245,197,66,.25), rgba(99,102,241,.25));
      display:flex;align-items:center;justify-content:center;font-weight:800;
      border:1px solid var(--line);
    }
    .title h1{margin:0;font-size:18px}
    .title p{margin:2px 0 0;color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);border-radius:999px;padding:8px 12px;
      background:rgba(255,255,255,.04);
      color:var(--text);font-size:13px;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;transition:.15s;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      font-weight:700;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    .btn.primary{background:rgba(245,197,66,.16);border-color:rgba(245,197,66,.35);color:var(--text)}
    .btn.primary:hover{background:rgba(245,197,66,.22)}
    .btn.good{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.35)}
    .btn.bad{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.35)}
    .grid{
      display:grid;gap:14px;margin-top:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: 1.05fr .95fr;}
    }
    .card{
      border:1px solid var(--line);border-radius:var(--radius);
      background:rgba(18,24,38,.80);backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 8px;font-size:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    .input, select{
      width:100%;
      padding:12px 12px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    .input::placeholder{color:rgba(154,164,178,.75)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .msg{
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);font-size:13px;
      white-space:pre-wrap;
    }
    .msg.good{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10)}
    .msg.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10)}
    .products{
      display:grid;gap:12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 560px){
      .products{grid-template-columns: 1fr 1fr;}
    }
    .p{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:18px;
      overflow:hidden;
    }
    .p .img{
      width:100%;height:170px;background:#0e1422;
      display:flex;align-items:center;justify-content:center;
      border-bottom:1px solid var(--line);
    }
    .p img{width:100%;height:170px;object-fit:cover;display:block}
    .p .b{padding:12px}
    .p h3{margin:0 0 6px;font-size:14px}
    .p .meta{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px}
    .p .price{font-size:16px;font-weight:900;color:var(--accent)}
    .p .fee{font-size:12px;color:rgba(245,197,66,.9)}
    .p .actions{margin-top:10px;display:flex;gap:8px}
    .p .actions .btn{flex:1}
    .small{font-size:12px;color:var(--muted)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);font-size:12px;color:var(--text);
    }
    .right{justify-content:flex-end}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .k{border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.03);padding:10px}
    .k .v{font-size:18px;font-weight:900;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">LV</div>
        <div class="title">
          <h1>LUNEVIERA â€” Marketplace</h1>
          <p class="muted">USDT TRC20/BEP20 â€¢ Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© 8%</p>
        </div>
      </div>

      <div class="row right" style="flex:0 0 auto; gap:10px">
        <div class="pill" id="userPill">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
        <button class="btn bad" id="logoutBtn" style="display:none">Ø®Ø±ÙˆØ¬</button>
        <button class="btn" id="refreshBtn">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Products + Cart -->
      <div class="card">
        <div class="row" style="align-items:flex-end">
          <div>
            <h2>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
            <div class="small">Ø§Ù„ÙƒÙ„ ÙŠØ±Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Public). Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø© Ø«Ù… Checkout Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨.</div>
          </div>
          <div class="row" style="flex:0 0 auto">
            <select id="categoryFilter" style="min-width:160px">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option>Ø¹Ø·Ø±</option>
              <option>Ù†Ø¸Ø§Ø±Ø§Øª</option>
              <option>Ù…Ù„Ø§Ø¨Ø³</option>
              <option>Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</option>
              <option>Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <input class="input" id="searchBox" placeholder="Ø¨Ø­Ø« (Ù…Ø«Ø§Ù„: Ø¹Ø·Ø± / Ù†Ø¸Ø§Ø±Ø§Øª)" />
          <button class="btn" id="clearSearchBtn" style="flex:0 0 auto">Ù…Ø³Ø­</button>
        </div>

        <div class="sep"></div>

        <div id="productsBox" class="products"></div>

        <div class="sep"></div>

        <h2>Ø§Ù„Ø³Ù„Ø©</h2>
        <div class="small">Ø§Ù„Ø³Ù„Ø© Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ (localStorage). Ø§Ù„Ø·Ù„Ø¨ ÙŠÙØ­ÙØ¸ ÙÙŠ Supabase.</div>
        <div class="sep"></div>

        <div id="cartBox"></div>
        <div class="row" style="margin-top:10px; align-items:center">
          <div class="badge" id="cartTotalBadge">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 USDT</div>
          <div class="badge" id="cartFeeBadge">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© (8%): 0 USDT</div>
          <button class="btn primary" id="checkoutBtn" style="flex:0 0 auto">Checkout</button>
          <button class="btn" id="clearCartBtn" style="flex:0 0 auto">ØªÙØ±ÙŠØº</button>
        </div>

        <div class="sep"></div>
        <div id="mainMsg" class="msg muted">Ø¬Ø§Ù‡Ø².</div>
      </div>

      <!-- RIGHT: Auth + Seller + Admin -->
      <div class="card">
        <h2>Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
        <div class="small">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ / Ø¯Ø®ÙˆÙ„. Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø³ØªØ¸Ù‡Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹.</div>

        <div class="sep"></div>

        <div class="row">
          <input class="input" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
          <input class="input" id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (8 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±)" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn good" id="signupBtn">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
          <button class="btn primary" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div class="sep"></div>

        <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹</h2>
        <div class="small">Ø£Ø¶Ù Ù…Ù†ØªØ¬Ùƒ (Ø³ÙŠÙØ³Ø¬Ù‘Ù„ Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ). Ø«Ù… Ø³ØªØ¬Ø¯Ù‡ ÙÙŠ â€œÙ…Ù†ØªØ¬Ø§ØªÙŠâ€.</div>

        <div class="sep"></div>

        <div id="sellerLocked" class="msg">ğŸ”’ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹.</div>

        <div id="sellerPanel" style="display:none">
          <div class="row">
            <select id="newCategory">
              <option>Ø¹Ø·Ø±</option>
              <option>Ù†Ø¸Ø§Ø±Ø§Øª</option>
              <option>Ù…Ù„Ø§Ø¨Ø³</option>
              <option>Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</option>
              <option>Ø£Ø®Ø±Ù‰</option>
            </select>
            <input class="input" id="newTitle" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
          </div>

          <div class="row" style="margin-top:10px">
            <input class="input" id="newPrice" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: 30)" inputmode="decimal" />
            <input class="input" id="newImage" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (https://...jpg/png)" />
          </div>

          <div class="row" style="margin-top:10px">
            <input class="input" id="newDesc" placeholder="ÙˆØµÙ Ù‚ØµÙŠØ±" />
            <button class="btn good" id="addProductBtn" style="flex:0 0 auto">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
          </div>

          <div class="sep"></div>

          <h2>Ù…Ù†ØªØ¬Ø§ØªÙŠ</h2>
          <div id="myProductsBox" class="products"></div>

          <div class="sep"></div>

          <h2>Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
          <div class="small">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ù‚Ø§Ù… Ø¨Ù‡Ø§ Ø­Ø³Ø§Ø¨Ùƒ (ÙƒÙ…Ø´ØªØ±ÙŠ).</div>
          <div id="myOrdersBox" class="msg muted">Ù„Ø§ Ø´ÙŠØ¡ Ø¨Ø¹Ø¯.</div>
        </div>

        <div class="sep"></div>

        <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
        <div class="small">ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…Ù† UID: <b>6ca64249-8ed9-4b8e-a7fa-ac2f42671cdd</b></div>

        <div id="adminLocked" class="msg">ğŸ”’ ØºÙŠØ± Ù…ØªØ§Ø­Ø©.</div>
        <div id="adminPanel" style="display:none">
          <div class="kpi">
            <div class="k"><div class="muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</div><div class="v" id="kUsers">-</div></div>
            <div class="k"><div class="muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div><div class="v" id="kListings">-</div></div>
            <div class="k"><div class="muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div><div class="v" id="kOrders">-</div></div>
            <div class="k"><div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ©</div><div class="v" id="kFees">-</div></div>
          </div>
          <div class="sep"></div>
          <button class="btn" id="reloadAdminBtn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
          <div class="sep"></div>
          <div class="msg muted">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¯Ù‚Ø© ÙŠØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ§Øª admin/service role. Ù‡Ù†Ø§ Ù†Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¡Ø§Øª â€œØ§Ù„Ù…Ù†ØªØ¬Ø§Øª/Ø§Ù„Ø·Ù„Ø¨Ø§Øª/Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©â€ Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·.</div>
        </div>

        <div class="sep"></div>
        <div id="sideMsg" class="msg muted">Ø¬Ø§Ù‡Ø².</div>
      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    /*********** 1) Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ ***********/
    const SUPABASE_URL = "PUT_YOUR_SUPABASE_URL_HERE";
    const SUPABASE_ANON_KEY = "PUT_YOUR_SUPABASE_ANON_KEY_HERE";
    /************************************************/

    const ADMIN_UID = "6ca64249-8ed9-4b8e-a7fa-ac2f42671cdd";
    const PLATFORM_FEE_RATE = 0.08;

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI refs
    const el = (id)=>document.getElementById(id);
    const mainMsg = el("mainMsg");
    const sideMsg = el("sideMsg");
    const userPill = el("userPill");
    const logoutBtn = el("logoutBtn");

    const productsBox = el("productsBox");
    const myProductsBox = el("myProductsBox");
    const myOrdersBox = el("myOrdersBox");

    const sellerLocked = el("sellerLocked");
    const sellerPanel  = el("sellerPanel");

    const adminLocked = el("adminLocked");
    const adminPanel  = el("adminPanel");

    // Cart
    const CART_KEY = "luneviera_cart_v1";
    const readCart = ()=> JSON.parse(localStorage.getItem(CART_KEY) || "[]");
    const writeCart = (arr)=> localStorage.setItem(CART_KEY, JSON.stringify(arr));

    function setMsg(target, text, type=""){
      target.className = "msg " + (type ? type : "muted");
      target.textContent = text;
    }

    function fmt(n){
      const x = Number(n||0);
      return (Math.round(x*100)/100).toFixed(2).replace(/\.00$/,"");
    }

    function calcFee(total){ return total * PLATFORM_FEE_RATE; }

    function safeUrl(url){
      try{
        const u = new URL(url);
        return u.href;
      }catch{ return ""; }
    }

    async function getUser(){
      const { data } = await supabase.auth.getUser();
      return data.user || null;
    }

    function setAuthedUI(user){
      if(user){
        userPill.textContent = user.email;
        logoutBtn.style.display = "";
        sellerLocked.style.display = "none";
        sellerPanel.style.display = "";
      }else{
        userPill.textContent = "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
        logoutBtn.style.display = "none";
        sellerLocked.style.display = "";
        sellerPanel.style.display = "none";
        adminLocked.style.display = "";
        adminPanel.style.display = "none";
      }
    }

    function isAdmin(user){ return user && user.id === ADMIN_UID; }

    function renderProducts(listings){
      productsBox.innerHTML = "";
      if(!listings.length){
        productsBox.innerHTML = `<div class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª.</div>`;
        return;
      }

      for(const p of listings){
        const price = Number(p.price||0);
        const fee = calcFee(price);

        const img = safeUrl(p.image_url) ? `<img src="${p.image_url}" alt="">` : `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>`;

        const card = document.createElement("div");
        card.className = "p";
        card.innerHTML = `
          <div class="img">${img}</div>
          <div class="b">
            <div class="meta">
              <span class="badge">${p.category || "Ø£Ø®Ø±Ù‰"}</span>
              <span class="badge">${p.status || "active"}</span>
            </div>
            <h3>${escapeHtml(p.title || "")}</h3>
            <div class="meta">
              <span class="price">USDT ${fmt(price)}</span>
              <span class="fee">Ø¹Ù…ÙˆÙ„Ø© 8%: ${fmt(fee)} USDT</span>
            </div>
            <div class="small" style="margin-top:6px">${escapeHtml(p.description || "")}</div>
            <div class="actions">
              <button class="btn primary" data-add="${p.id}">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
            </div>
          </div>
        `;
        productsBox.appendChild(card);
      }

      productsBox.querySelectorAll("[data-add]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-add");
          addToCart(id);
        });
      });
    }

    function renderMyProducts(listings){
      myProductsBox.innerHTML = "";
      if(!listings.length){
        myProductsBox.innerHTML = `<div class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ùƒ Ø¨Ø¹Ø¯.</div>`;
        return;
      }

      for(const p of listings){
        const img = safeUrl(p.image_url) ? `<img src="${p.image_url}" alt="">` : `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>`;
        const card = document.createElement("div");
        card.className = "p";
        card.innerHTML = `
          <div class="img">${img}</div>
          <div class="b">
            <div class="meta">
              <span class="badge">${p.category || "Ø£Ø®Ø±Ù‰"}</span>
              <span class="badge">${p.status || "active"}</span>
            </div>
            <h3>${escapeHtml(p.title || "")}</h3>
            <div class="meta">
              <span class="price">USDT ${fmt(p.price||0)}</span>
              <span class="muted">ID: ${p.id}</span>
            </div>
            <div class="small" style="margin-top:6px">${escapeHtml(p.description || "")}</div>
            <div class="actions">
              <button class="btn bad" data-del="${p.id}">Ø­Ø°Ù</button>
            </div>
          </div>
        `;
        myProductsBox.appendChild(card);
      }

      myProductsBox.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const user = await getUser();
          if(!user) return setMsg(sideMsg, "Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.", "bad");

          const id = btn.getAttribute("data-del");
          const { error } = await supabase.from("listings").delete().eq("id", id);
          if(error) return setMsg(sideMsg, "Ø®Ø·Ø£ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬: " + error.message, "bad");

          setMsg(sideMsg, "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬.", "good");
          await refreshAll();
        });
      });
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ========= Supabase fetch =========
    async function loadListings(){
      const q = (el("searchBox").value || "").trim();
      const cat = el("categoryFilter").value || "";

      let query = supabase
        .from("listings")
        .select("id,title,description,price,image_url,category,status,seller_id,created_at")
        .eq("status","active")
        .order("created_at", { ascending:false });

      if(cat) query = query.eq("category", cat);
      if(q)   query = query.ilike("title", `%${q}%`);

      const { data, error } = await query;
      if(error){
        setMsg(mainMsg, "Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: " + error.message, "bad");
        renderProducts([]);
        return [];
      }
      renderProducts(data || []);
      setMsg(mainMsg, "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.", "good");
      return data || [];
    }

    async function loadMyListings(user){
      const { data, error } = await supabase
        .from("listings")
        .select("id,title,description,price,image_url,category,status,created_at")
        .eq("seller_id", user.id)
        .order("created_at", { ascending:false });

      if(error){
        setMsg(sideMsg, "Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§ØªÙƒ: " + error.message + "\n(ØºØ§Ù„Ø¨Ù‹Ø§ Ø³ÙŠØ§Ø³Ø© RLS ØªÙ…Ù†Ø¹ Ø£Ùˆ seller_id ØºÙŠØ± ØµØ­ÙŠØ­)", "bad");
        renderMyProducts([]);
        return [];
      }
      renderMyProducts(data || []);
      return data || [];
    }

    async function loadMyOrders(user){
      // ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ…Ø´ØªØ±ÙŠ
      const { data, error } = await supabase
        .from("orders")
        .select("id,status,total_amount,platform_fee,created_at")
        .eq("buyer_id", user.id)
        .order("created_at", { ascending:false });

      if(error){
        myOrdersBox.className="msg bad";
        myOrdersBox.textContent = "Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: " + error.message;
        return;
      }
      if(!data || !data.length){
        myOrdersBox.className="msg muted";
        myOrdersBox.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.";
        return;
      }

      const lines = data.map(o =>
        `â€¢ ${o.id}\n  Ø§Ù„Ø­Ø§Ù„Ø©: ${o.status} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${fmt(o.total_amount)} USDT | Ø¹Ù…ÙˆÙ„Ø©: ${fmt(o.platform_fee)} USDT`
      ).join("\n\n");
      myOrdersBox.className="msg good";
      myOrdersBox.textContent = lines;
    }

    // ========= Cart =========
    function cartTotal(){
      const cart = readCart();
      const total = cart.reduce((s,it)=> s + Number(it.price||0)*Number(it.qty||1), 0);
      return total;
    }

    function renderCart(){
      const cart = readCart();
      const box = el("cartBox");
      box.innerHTML = "";

      if(!cart.length){
        box.innerHTML = `<div class="msg">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.</div>`;
      }else{
        const items = document.createElement("div");
        items.className = "msg";
        items.style.background = "rgba(255,255,255,.03)";
        items.innerHTML = cart.map(it=>`
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;border-bottom:1px solid rgba(255,255,255,.08);padding:8px 0">
            <div>
              <b>${escapeHtml(it.title)}</b>
              <div class="small">USDT ${fmt(it.price)} Ã— ${it.qty}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" data-minus="${it.id}" style="padding:8px 10px">-</button>
              <button class="btn" data-plus="${it.id}" style="padding:8px 10px">+</button>
              <button class="btn bad" data-rm="${it.id}" style="padding:8px 10px">Ø­Ø°Ù</button>
            </div>
          </div>
        `).join("");
        box.appendChild(items);

        box.querySelectorAll("[data-minus]").forEach(b=>b.onclick=()=>changeQty(b.dataset.minus,-1));
        box.querySelectorAll("[data-plus]").forEach(b=>b.onclick=()=>changeQty(b.dataset.plus,+1));
        box.querySelectorAll("[data-rm]").forEach(b=>b.onclick=()=>removeFromCart(b.dataset.rm));
      }

      const total = cartTotal();
      el("cartTotalBadge").textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${fmt(total)} USDT`;
      el("cartFeeBadge").textContent = `Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© (8%): ${fmt(calcFee(total))} USDT`;
    }

    async function addToCart(listingId){
      // Ù†Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† supabase (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØµØ­ÙŠØ­)
      const { data, error } = await supabase
        .from("listings")
        .select("id,title,price,status")
        .eq("id", listingId)
        .single();

      if(error) return setMsg(mainMsg, "Ø®Ø·Ø£ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©: " + error.message, "bad");
      if(!data || data.status !== "active") return setMsg(mainMsg, "Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­.", "bad");

      const cart = readCart();
      const idx = cart.findIndex(x=>x.id===data.id);
      if(idx>=0) cart[idx].qty += 1;
      else cart.push({ id:data.id, title:data.title, price:Number(data.price||0), qty:1 });

      writeCart(cart);
      renderCart();
      setMsg(mainMsg, "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø© âœ…", "good");
    }

    function changeQty(id, delta){
      const cart = readCart();
      const idx = cart.findIndex(x=>x.id===id);
      if(idx<0) return;
      cart[idx].qty += delta;
      if(cart[idx].qty <= 0) cart.splice(idx,1);
      writeCart(cart);
      renderCart();
    }

    function removeFromCart(id){
      const cart = readCart().filter(x=>x.id!==id);
      writeCart(cart);
      renderCart();
    }

    // ========= Checkout (orders + order_items) =========
    async function checkout(){
      const user = await getUser();
      if(!user) return setMsg(mainMsg, "Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨.", "bad");

      const cart = readCart();
      if(!cart.length) return setMsg(mainMsg, "Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.", "bad");

      const total = cartTotal();
      const fee = calcFee(total);

      // 1) Ø£Ù†Ø´Ø¦ order
      const { data: order, error: e1 } = await supabase
        .from("orders")
        .insert({
          buyer_id: user.id,
          status: "pending",
          total_amount: total,
          platform_fee: fee
        })
        .select("id")
        .single();

      if(e1) return setMsg(mainMsg, "Ø®Ø·Ø£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨: " + e1.message, "bad");

      // 2) Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ù„Ø¨
      const itemsPayload = cart.map(it=>({
        order_id: order.id,
        listing_id: it.id,
        qty: it.qty,
        unit_price: it.price
      }));

      const { error: e2 } = await supabase.from("order_items").insert(itemsPayload);
      if(e2) return setMsg(mainMsg, "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù„ÙƒÙ† Ø®Ø·Ø£ ÙÙŠ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ù„Ø¨: " + e2.message, "bad");

      // 3) ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø© + ØªØ­Ø¯ÙŠØ«
      writeCart([]);
      renderCart();
      setMsg(mainMsg, "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ… Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: " + order.id, "good");
      await loadMyOrders(user);

      // Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ ØªØ³ØªØ·ÙŠØ¹ ØªØ¹Ù…Ù„ ØµÙØ­Ø© â€œØ¯ÙØ¹ USDTâ€ Ø£Ùˆ â€œØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹â€ Ø­Ø³Ø¨ ØªØµÙ…ÙŠÙ…Ùƒ.
    }

    // ========= Add listing =========
    async function addListing(){
      const user = await getUser();
      if(!user) return setMsg(sideMsg, "Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.", "bad");

      const category = el("newCategory").value.trim();
      const title = el("newTitle").value.trim();
      const price = Number(String(el("newPrice").value).replace(",","."));
      const image_url = el("newImage").value.trim();
      const description = el("newDesc").value.trim();

      if(!title || !Number.isFinite(price) || price<=0){
        return setMsg(sideMsg, "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ + Ø³Ø¹Ø± ØµØ­ÙŠØ­.", "bad");
      }

      if(image_url && !safeUrl(image_url)){
        return setMsg(sideMsg, "Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± ØµØ­ÙŠØ­. Ù„Ø§Ø²Ù… ÙŠØ¨Ø¯Ø£ https://", "bad");
      }

      // insert
      const { error } = await supabase.from("listings").insert({
        seller_id: user.id,
        category,
        title,
        description,
        price,
        image_url: image_url || null,
        status: "active"
      });

      if(error){
        return setMsg(sideMsg,
          "Ø®Ø·Ø£ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬: " + error.message +
          "\nØ¥Ø°Ø§ ÙŠÙ‚ÙˆÙ„ RLS: Ù…Ø¹Ù†Ø§Ù‡Ø§ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ…Ù†Ø¹ INSERT â€” Ù„Ø§Ø²Ù… Ø³ÙŠØ§Ø³Ø© insert ØªØ³Ù…Ø­ Ù„Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†.",
          "bad"
        );
      }

      el("newTitle").value = "";
      el("newPrice").value = "";
      el("newImage").value = "";
      el("newDesc").value = "";

      setMsg(sideMsg, "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ âœ…", "good");
      await refreshAll();
    }

    // ========= Admin stats =========
    async function loadAdminStats(){
      const user = await getUser();
      if(!isAdmin(user)) return;

      // listings count
      const { count: listingsCount, error: eL } = await supabase
        .from("listings").select("id", { count:"exact", head:true });

      // orders count
      const { count: ordersCount, error: eO } = await supabase
        .from("orders").select("id", { count:"exact", head:true });

      // sum platform_fee
      const { data: feesRows, error: eF } = await supabase
        .from("orders")
        .select("platform_fee");

      const feesSum = (feesRows||[]).reduce((s,r)=> s + Number(r.platform_fee||0), 0);

      el("kListings").textContent = eL ? "â€”" : String(listingsCount ?? "-");
      el("kOrders").textContent   = eO ? "â€”" : String(ordersCount ?? "-");
      el("kFees").textContent     = eF ? "â€”" : (fmt(feesSum) + " USDT");

      // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¯Ù‚Ø© ÙŠØ­ØªØ§Ø¬ service roleØŒ Ù„Ø°Ù„Ùƒ Ù†ÙƒØªØ¨ â€œØºÙŠØ± Ù…ØªØ§Ø­ Ù‡Ù†Ø§â€
      el("kUsers").textContent = "ÙŠØ­ØªØ§Ø¬ Admin Key";

      if(eL||eO||eF){
        setMsg(sideMsg, "ØªÙ†Ø¨ÙŠÙ‡: Ø¨Ø¹Ø¶ Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙØ´Ù„Øª Ø¨Ø³Ø¨Ø¨ Ø³ÙŠØ§Ø³Ø§Øª RLS Ø£Ùˆ ØµÙ„Ø§Ø­ÙŠØ§Øª.", "bad");
      }
    }

    // ========= Refresh all =========
    async function refreshAll(){
      renderCart();
      const user = await getUser();
      setAuthedUI(user);

      await loadListings();

      if(user){
        await loadMyListings(user);
        await loadMyOrders(user);

        if(isAdmin(user)){
          adminLocked.style.display = "none";
          adminPanel.style.display = "";
          await loadAdminStats();
        }else{
          adminLocked.style.display = "";
          adminPanel.style.display = "none";
        }
      }
    }

    // ========= Auth actions =========
    async function signup(){
      const email = el("email").value.trim();
      const password = el("password").value;

      const { error } = await supabase.auth.signUp({ email, password });
      if(error) return setMsg(sideMsg, "Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯: " + error.message, "bad");

      setMsg(sideMsg, "ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âœ…\nÙ‚Ø¯ ÙŠØ·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø­Ø³Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase.", "good");
      await refreshAll();
    }

    async function login(){
      const email = el("email").value.trim();
      const password = el("password").value;

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) return setMsg(sideMsg, "Ø®Ø·Ø£ Ø¯Ø®ÙˆÙ„: " + error.message, "bad");

      setMsg(sideMsg, "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…", "good");
      await refreshAll();
    }

    async function logout(){
      const { error } = await supabase.auth.signOut();
      if(error) return setMsg(sideMsg, "Ø®Ø·Ø£ Ø®Ø±ÙˆØ¬: " + error.message, "bad");

      setMsg(sideMsg, "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ âœ…", "good");
      await refreshAll();
    }

    // ========= Events =========
    el("signupBtn").addEventListener("click", signup);
    el("loginBtn").addEventListener("click", login);
    el("logoutBtn").addEventListener("click", logout);

    el("addProductBtn").addEventListener("click", addListing);
    el("checkoutBtn").addEventListener("click", checkout);
    el("clearCartBtn").addEventListener("click", ()=>{ writeCart([]); renderCart(); setMsg(mainMsg,"ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©.","good"); });

    el("refreshBtn").addEventListener("click", refreshAll);
    el("reloadAdminBtn").addEventListener("click", loadAdminStats);

    el("clearSearchBtn").addEventListener("click", ()=>{
      el("searchBox").value = "";
      refreshAll();
    });

    el("searchBox").addEventListener("input", ()=>{
      // ØªØ­Ù…ÙŠÙ„ Ø®ÙÙŠÙ
      loadListings();
    });

    el("categoryFilter").addEventListener("change", loadListings);

    // Listen to auth changes
    supabase.auth.onAuthStateChange(async ()=>{
      await refreshAll();
    });

    // Start
    (async ()=>{
      if(SUPABASE_URL.includes("PUT_YOUR") || SUPABASE_ANON_KEY.includes("PUT_YOUR")){
        setMsg(mainMsg, "Ø¶Ø¹ SUPABASE_URL Ùˆ SUPABASE_ANON_KEY ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø«Ù… Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ GitHub Pages.", "bad");
        setMsg(sideMsg, "Ø¶Ø¹ SUPABASE_URL Ùˆ SUPABASE_ANON_KEY Ø£ÙˆÙ„Ø§Ù‹.", "bad");
      }
      await refreshAll();
    })();
  </script>
</body>
</html>
